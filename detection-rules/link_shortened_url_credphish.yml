name: "Link: Shortened URL resolving to credential phishing page"
description: |
  Detects messages containing shortened URLs (bit.ly, t.co, tinyurl, is.gd, ow.ly, etc.)
  where link analysis resolves the redirect chain and finds a credential phishing page.
  This specifically targets URL shortener abuse as a phishing delivery mechanism, catching
  cases where the final destination is a credential harvesting page hidden behind one or
  more redirects.
type: "rule"
severity: "high"
source: |
  type.inbound

  // message contains links
  and length(body.links) > 0

  // at least one link uses a URL shortener service
  and any(body.links,
          (
            .href_url.domain.root_domain in $url_shorteners
            or .href_url.domain.domain in $url_shorteners
          )

          // link analysis resolves to a credential phishing page
          and ml.link_analysis(., mode="aggressive").credphish.disposition == "phishing"

          // redirect chain is present (URL was actually shortened/redirected)
          and length(ml.link_analysis(., mode="aggressive").redirect_history) > 0

          // final destination is not an org domain
          and ml.link_analysis(., mode="aggressive").effective_url.domain.root_domain not in $org_domains
  )

  // sender profile: new, outlier, unsolicited, or previously malicious
  and (
    (
      profile.by_sender_email().prevalence in ("new", "outlier")
      and not profile.by_sender_email().solicited
    )
    or (
      profile.by_sender_email().any_messages_malicious_or_spam
      and not profile.by_sender_email().any_messages_benign
    )
  )

  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  and not profile.by_sender_email().any_messages_benign
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Sender analysis"
  - "URL analysis"
id: "a1b2c3d4-0002-4000-8000-shortcredphish"
